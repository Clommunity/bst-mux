<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>BST</title>
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.1.0/flatly/bootstrap.min.css">
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css">
</head>
<script src="http://code.angularjs.org/1.2.10/angular.min.js"></script>
<script src="http://code.angularjs.org/1.2.10/angular-resource.min.js"></script>
<script src="http://code.angularjs.org/1.2.10/angular-route.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/restangular/1.4.0/restangular.min.js"></script>

<body>
	<div ng-app="project">
		<div class="jumbotron">
			<a href="/logout">
			<button class="btn pull-right">Logout</button>
			</a>
			<a href="#/new">
			<button class="btn btn-primary pull-right">
				<i class="fa fa-plus"></i> Add user
			</button>
			</a>
			<h1>Administrative System</h1>
		</div>
	
		<div ng-view></div>
		
	<script type="text/ng-template" id="list.html">
	<div class="container-fluid">
		<div class="row">
			<div class="col-sm-3 well">
				<h3>Users</h3>
				<ul class="nav nav-pills nav-stacked">
					<li ng-class="{active: u.Name == selected.Name}" ng-repeat="u in users">
						<a href="" ng-click="get($index)">{{u.Name}}</a>
					</li>
				</ul>
			</div>
			<div class="col-sm-6">
				<h2>{{selected.Name}}</h2>
				<dl class="dl-horizontal">
					<dt>Email:</dt>
					<dd>{{selected.Email}}</dd>
				</dl>
				<dl class="dl-horizontal">
					<dt>HomePath:</dt>
					<dd>{{selected.HomePath}}</dd>
				</dl>
				<dl class="dl-horizontal">
					<dt>GUI Port:</dt>
					<dd>{{selected.GuiPort}}</dd>
				</dl>
				<dl class="dl-horizontal">
					<dt>Listen Port:</dt>
					<dd>{{selected.ListenPort}}</dd>
				</dl>
				<dl class="dl-horizontal">
					<dt>Group:</dt>
					<dd>{{selected.Group}}</dd>
				</dl>
				<dl class="dl-horizontal">
					<dt>Status:</dt>
					<dd>{{selected.Status}}</dd>
				</dl>
			</div>
			<div class="col-sm-3">
				<button class="btn btn-primary form-control" ng-click="update(selected.idx)">
					<i class="fa fa-pencil"></i> Update this User
				</button>
				<button class="btn btn-danger form-control" ng-click="remove(selected.idx)">
					<i class="fa fa-trash-o"></i> Remove this User
				</button>
			</div>
		</div>
	</div>
	</script>

	<script type="text/ng-template" id="detail.html">
	<div class="container-fluid">
		<div class="row">
			<div class="col-sm-3 well">
			</div>				
			<div class="col-sm-6 ng-hide">
				<form>
					<fieldset>
						<div class='modal-body'>
							<label>Name</label>
							<input type='text' ng-model="selected.Name"/>
							<label>Email</label>
							<input type='text' ng-model="selected.Email"/>
							<label>GUI Port</label>
							<input type='text' ng-model="selected.Guiport"/>
							<label>Listen Port</label>
							<input type='text' ng-model="selected.Listenport"/>
							<label>Group</label>
							<input type='text' ng-model="selected.Group"/>
							<label>Status</label>
							<input type='text' ng-model="selected.Status"/>
							<label>Options</label>
							<div ng-repeat="vo in selected.voteoptions">
								<input type='text' ng-model="vo.name"/>
								<i class="icon-trash" ng-click='removeVoteOption(vo)'></i>
							</div>
						</div>
						<div class='modal-footer'>
							<button type='submit' class="btn btn-danger" data-dismiss="modal" ng-click="delete()">Delete</button>
							<button type='submit' class="btn btn-primary" data-dismiss="modal" ng-click="save()">Save</button>
						</div>
					</fieldset>
				</form>		
			</div>
			<div class="col-sm-3">
			</div>
		</div>
	</div>
	</script>

<script>
angular.module('user', ['restangular', 'ngRoute']).
  config(function($routeProvider, RestangularProvider) {
    $routeProvider.
      when('/', {
        controller:ListCtrl, 
        templateUrl:'list.html'
      }).
      when('/edit/:projectId', {
        controller:EditCtrl, 
        templateUrl:'detail.html',
        resolve: {
          user: function(Restangular, $route){
            return Restangular.one('users', $route.current.params.userId).get();
          }
        }
      }).
      when('/new', {controller:CreateCtrl, templateUrl:'detail.html'}).
      otherwise({redirectTo:'/'});
      
      RestangularProvider.setBaseUrl('/admin');
      RestangularProvider.setRestangularFields({
        id: '_id.$oid'
      });
      
      RestangularProvider.setRequestInterceptor(function(elem, operation, what) {
        
        if (operation === 'put') {
          elem._id = undefined;
          return elem;
        }
        return elem;
      })
  });


function ListCtrl($scope, Restangular) {
   $scope.users = Restangular.all("users").getList().$object;
}


function CreateCtrl($scope, $location, Restangular) {
  $scope.save = function() {
    Restangular.all('projects').post($scope.project).then(function(project) {
      $location.path('/list');
    });
  }
}

function EditCtrl($scope, $location, Restangular, project) {
  var original = project;
  $scope.project = Restangular.copy(original);
  

  $scope.isClean = function() {
    return angular.equals(original, $scope.project);
  }

  $scope.destroy = function() {
    original.remove().then(function() {
      $location.path('/list');
    });
  };

  $scope.save = function() {
    $scope.project.put().then(function() {
      $location.path('/');
    });
  };
}
</script>
</body>
</html>
